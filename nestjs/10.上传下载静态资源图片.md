## 上传和下载图片

`上传图片`通过`multer`和`@nestjs/platform-express`实现，`@nestjs/platform-express`是`nestjs-cli`自带的。
`下载图片`一般使用这两种方法，第一种是`通过nestjs自带的download方法直接访问下载`，第二种是`通过压缩成zip压缩包，通过流的方式进行下载`

### 构建项目

```sh
nest new test
# 下载依赖
# multer: 文件夹存储处理库
# @types/multer: ts声明文件
# compressing: 压缩文件，例如 压缩zip
npm i multer @types/multer compressing
```

### 新建一个 upload 模块

```sh
nest g res upload
```

### 添加访问静态资源路径

```ts
// main.ts

import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import { NestExpressApplication } from "@nestjs/platform-express";
import { join } from "path";

let serviceUrl: string;

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule);
  // 将存放上传东西的目录变为静态资源目录，并添加静态访问路径
  app.useStaticAssets(join(__dirname, "./static"), {
    prefix: "/static", // 访问前缀，例如：http://localhost:3000/static/xxxx.png
  });
  await app.listen(process.env.PORT ?? 3000);

  // 当前服务地址
  serviceUrl = await app.getUrl();
  console.log(serviceUrl);
}
bootstrap();

export {
  serviceUrl, // 将服务地址导出，给上传完成以后做拼接地址，返回完整的访问图片地址
};
```

### upload 模块添加文件存放

```ts
// upload.module.ts

import { Module } from "@nestjs/common";
import { UploadService } from "./upload.service";
import { UploadController } from "./upload.controller";
import { MulterModule } from "@nestjs/platform-express";
import { diskStorage } from "multer";
import { join, extname } from "path";

@Module({
  imports: [
    // 使用 MulterModule 注册静态资源目录
    MulterModule.register({
      // 存放位置
      storage: diskStorage({
        destination: join(__dirname, "../static/upload"), // 静态资源目录位置
        filename: function (req, file, cb) {
          // 存储的文件名称
          // file.fieldname: formdata的key, file.originalname: 文件原名
          // console.log(file.fieldname, file, 1111111111111111);
          const fileName = `${new Date().getTime() + file.originalname}`;
          return cb(null, fileName);
        },
      }),
    }),
  ],
  controllers: [UploadController],
  providers: [UploadService],
})
export class UploadModule {}
```

### 编写上传接口

`上传图片`通过`multer`和`@nestjs/platform-express`实现，`@nestjs/platform-express`是`nestjs-cli`自带的。

```ts
// upload.controller.ts

import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseInterceptors,
  UploadedFile,
} from "@nestjs/common";
import { UploadService } from "./upload.service";
import { CreateUploadDto } from "./dto/create-upload.dto";
import { UpdateUploadDto } from "./dto/update-upload.dto";
import { FileInterceptor } from "@nestjs/platform-express";
import { extname } from "path";
import { serviceUrl } from "../main";

@Controller("file")
export class UploadController {
  constructor(private readonly uploadService: UploadService) {}

  /**
   * 上传图片
   * 使用 UseInterceptors 装饰器  FileInterceptor是单个 读取字段名称  FilesInterceptor是多个 读取字段名称, 也就是解析读取formdata里面的key
   * @param file 上传的file , 使用 UploadedFile 装饰器接受file 文件
   * @returns
   */
  @Post("upload")
  @UseInterceptors(FileInterceptor("file"))
  upload(@UploadedFile() file) {
    // console.log(file);
    const filename = file.filename;
    const path = `${serviceUrl}/static/upload/${filename}`;
    return {
      code: 200,
      msg: "上传成功",
      file: {
        path, // 完整访问路径
        filename, // 文件名
      },
    };
  }
}
```

### 下载图片

`下载图片`一般使用这两种方法，第一种是`通过nestjs自带的download方法直接访问下载`，第二种是`通过压缩成zip压缩包，通过流的方式进行下载`

```ts
import {
  Controller,
  Get,
  Post,
  Query,
  UseInterceptors,
  UploadedFile,
  Response,
} from "@nestjs/common";
import { UploadService } from "./upload.service";
import { FileInterceptor } from "@nestjs/platform-express";
import { join } from "path";
import { existsSync } from "node:fs";
import { serviceUrl } from "../main";
import { zip } from "compressing";

@Controller("file")
export class UploadController {
  constructor(private readonly uploadService: UploadService) {}
  /**
   * 下载图片
   * 两种方式: 1. 访问地址直接下载, 2. 压缩成zip，通过流的方式返回
   */
  @Get("download")
  async download(@Query() query, @Response() res) {
    const fileName = query.name; // 下载的文件名称
    const type = query.type || "file"; // 下载的方式，file：默认是直接下载    stream：流形式
    // 查询上传文件夹中是否存在需要下载的文件
    const staticPath = join(__dirname, "../static/upload", fileName);
    const isExist = existsSync(staticPath);
    console.log(isExist, staticPath);
    if (!isExist) {
      res.send({
        code: 404,
        msg: `没有（${fileName}）这个资源`,
      });
    } else {
      // 1. 直接下载
      if (type == "file") {
        res.download(staticPath);
      }
      // 2. 压缩成zip，通过流的方式传输
      else {
        const tarStream = new zip.Stream();
        await tarStream.addEntry(staticPath);
        // 将数据设置为流形式
        res.setHeader("Content-Type", "application/octet-stream");
        // “Content-Disposition” 在计算机领域通常指的是 MIME 协议的一部分，用于指示内容在接收方应如何被处理。
        // 例如，在 HTTP 协议中，它可以用来指示一个文件是应该被下载、在浏览器中显示，还是作为附件处理等。
        // 它可以带有不同的参数，如 “inline” 表示内容可以在页面内显示，“attachment” 表示内容应作为附件下载等
        // filename=dowmImage表示指定附件名称是 dowmImage
        res.setHeader("Content-Disposition", `attachment; filename=dowmImage`);
        tarStream.pipe(res);
      }
    }
  }
}
```

### 下载文件前端

```ts
// 第一种下载方式
fetch("http:localhost:3000/file/upload?name=xxxx.png");

// 第二种下载方式
fetch("http:localhost:3000/file/upload?name=xxxx.png&type=stream")
  .then((res) => res.arrayBuffer())
  .then((res) => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(
      new Blob([res], {
        // type:"image/png"
      })
    );
    a.download = "download.zip";
    a.click();
  });
```
