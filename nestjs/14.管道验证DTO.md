## 管道验证 DTO

类似`ts`的类型验证,只不过`DTO`验证的是接口限制的参数和类型，通过管道来验证`DTO层`

## 局部验证 dto

### 安装项目

```sh
# 创建项目
nest new test
# 进入项目
cd test
# 创建一个crud
nest g res dtopipe
# 新建一个通道 如果不知道命令可以 nest -h 查看
nest g pi dtopipe

# 安装验证器
npm i --save class-validator class-transformer
```

### 注册使用 pipe 通道

```ts
// dtopipe.controller.ts

import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from "@nestjs/common";
import { DtopipeService } from "./dtopipe.service";
import { CreateDtopipeDto } from "./dto/create-dtopipe.dto";
import { UpdateDtopipeDto } from "./dto/update-dtopipe.dto";
import { DtopipePipe } from "./dtopipe.pipe";

@Controller("dtopipe")
export class DtopipeController {
  constructor(private readonly dtopipeService: DtopipeService) {}

  @Post()
  // @Body(DtopipePipe): 将DtopipePipe通道注册验证到Body中,
  // createDtopipeDto: CreateDtopipeDto: 指定body类型，类似ts
  create(@Body(DtopipePipe) createDtopipeDto: CreateDtopipeDto) {
    return this.dtopipeService.create(createDtopipeDto);
  }

  @Get()
  findAll() {
    return this.dtopipeService.findAll();
  }

  @Get(":id")
  findOne(@Param("id") id: string) {
    return this.dtopipeService.findOne(+id);
  }

  @Patch(":id")
  update(@Param("id") id: string, @Body() updateDtopipeDto: UpdateDtopipeDto) {
    return this.dtopipeService.update(+id, updateDtopipeDto);
  }

  @Delete(":id")
  remove(@Param("id") id: string) {
    return this.dtopipeService.remove(+id);
  }
}
```

### 编写 dto 层规则

```ts
// create-dtopipe.dto.ts

import {
  IsString,
  IsNotEmpty,
  IsEmail,
  MinLength,
  MaxLength,
} from "class-validator";

export class CreateDtopipeDto {
  @IsNotEmpty({ message: "Email不能为空" }) // 验证是否为空
  @IsEmail({}, { message: "邮箱格式不正确" }) // 验证是否是邮件
  @IsString({ message: "Email只能为String类型" }) // 验证是否是字符串
  email: string;

  @IsNotEmpty({ message: "密码不能为空" })
  @MinLength(8, { message: "密码最少需要8位数" }) // 最少为8位数
  @MaxLength(16, { message: "密码最大只能是16位数" }) // 最长为16位数
  password: string;

  @IsNotEmpty({ message: "验证码不能为空" })
  code: any; // 验证码
}
```

### 编写 dto 通道验证

```ts
// dtopipe.pipe.ts

import {
  ArgumentMetadata,
  Injectable,
  PipeTransform,
  HttpException,
  HttpStatus,
} from "@nestjs/common";
import { plainToInstance } from "class-transformer";
import { validate } from "class-validator";

@Injectable()
export class DtopipePipe implements PipeTransform {
  // value：前端传过来的数据   metadata: 元数据
  async transform(value: any, metadata: ArgumentMetadata) {
    if (!metadata.metatype) {
      return value;
    }
    // 实例化dto
    const DTO = plainToInstance(metadata.metatype, value);
    // 验证, 返回的是验证错误数组
    const validateErrors = await validate(DTO);
    if (validateErrors.length > 0) {
      // 抛出错误
      throw new HttpException(validateErrors, HttpStatus.BAD_REQUEST);
    }
    return value;
  }
}
```

## 全局注册

使用自带的`ValidationPipe`注册全局验证管道

```ts
// main.ts

import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import { ValidationPipe } from "@nestjs/common";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // 注册全局验证dto
  app.useGlobalPipes(new ValidationPipe());
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```
