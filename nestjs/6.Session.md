## session

session 是服务器为每个用户的浏览器创建的一个会话对象, 这个 session 会记录到 浏览器的 cookie 用来区分用户

## 创建项目

```sh
nest new [项目名]
```

### 安装 express 的 session 库

因为`nestjs`默认的框架是`express`，所以我们使用`express-session`这个库去测试

```sh
# 安装库
npm i express-session --save

# 安装ts提示声明依赖
npm i @types/express-session -D

# 安装验证码库
npm install svg-captcha -S
```

### 配置和 express-session 库参数说明

#### express-session 库参数说明

|  参数   |                                                            说明                                                             |
| :-----: | :-------------------------------------------------------------------------------------------------------------------------: |
| secret  |                                           生成服务端 session 签名, 可以理解为加密                                           |
|  name   |                                          生成客户端 cookie 的名字 默认 connect.sid                                          |
| cookie  | 设置返回到前端 key 的属性，默认值为`{ path: ‘/’, httpOnly: true, secure: false, maxAge: null }`, `maxAge`的单位是`ms(毫秒)` |
| rolling |                              在每次请求时强行设置 cookie，这将重置 cookie 过期时间(默认:false)                              |

#### 配置

类似`express`导入一样，是中间件导入，也就是`app.use(xxxx)`

```ts
import { NestFactory } from "@nestjs/core";
import { VersioningType } from "@nestjs/common";
import { AppModule } from "./app.module";
import * as session from "express-session";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // 加入版本控制
  app.enableVersioning({
    type: VersioningType.URI,
  });
  // 注入session
  app.use(
    session({
      secret: "test-session", // 服务端 session 签名
      name: "test_session.session", // 客户端 cookie 的名字 默认 connect.sid
      rolling: true, // 在每次请求时强行设置 cookie，这将重置 cookie 过期时间(默认:false)
      cookie: {
        // cookie配置,设置返回到前端 key 的属性，默认值为`{ path: ‘/’, httpOnly: true, secure: false, maxAge: null }`, `maxAge`的单位是`ms(毫秒)`
        maxAge: 0,
      },
    })
  );
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

## 前后端

### 后端

1. 根据上述创建项目，并添加`session注入`
2. 在`app.controller.ts`文件中添加接口, 分别是`创建图片验证码`和`验证验证码`

```ts
import {
  Controller,
  Get,
  HttpCode,
  Request,
  Response,
  Post,
  Body,
} from "@nestjs/common";
import { AppService } from "./app.service";
// 验证码图片生成库
import * as svgCaptcha from "svg-captcha";

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  // 获取图片验证码
  @Get("/VerificationCode")
  @HttpCode(200)
  createCaptcha(@Request() req, @Response() res): any {
    const captcha = svgCaptcha.create({
      size: 4, //生成几个验证码
      fontSize: 50, //文字大小
      width: 100, //宽度
      height: 34, //高度
      background: "#cc9966", //背景颜色
    });
    req.session.code = captcha.text; //存储验证码记录到session
    console.log(captcha.text);

    // 直接返回图片
    // res.type('image/svg+xml')
    // res.send(captcha.data)

    // 将svg转换为base64
    const base64Data = Buffer.from(captcha.data).toString("base64");
    res.send(
      JSON.stringify({
        code: 200,
        msg: "获取成功",
        image: `data:image/svg+xml;base64,${base64Data}`,
      })
    );
  }

  // 验证并创建
  @Post("/create")
  createUser(@Request() req, @Body() body): any {
    console.log(req.session.code, body);
    if (
      req?.session?.code.toLocaleLowerCase() === body?.code?.toLocaleLowerCase()
    ) {
      return {
        code: 200,
        msg: "创建成功",
      };
    }
    return {
      code: 400,
      msg: "创建失败",
    };
  }
}
```

### 前端

1. 创建项目,新建文件夹,进入文件中

```sh
# 初始化npm配置文件
npm init
# 初始化ts配置文件
tsc --init
# 安装依赖
npm i element-plus vite vue @vitejs/plugin-vue
```

2. 配置`tsconfig.json`

```json
{
  "compilerOptions": {
    "baseUrl": "./",
    /* Language and Environment */
    "target": "es2016" /* Set the JavaScript language version for emitted JavaScript and include compatible library declarations. */,
    /* Modules */
    "module": "commonjs" /* Specify what module code is generated. */,
    "esModuleInterop": true /* Emit additional JavaScript to ease support for importing CommonJS modules. This enables 'allowSyntheticDefaultImports' for type compatibility. */,
    // "preserveSymlinks": true,                         /* Disable resolving symlinks to their realpath. This correlates to the same flag in node. */
    "forceConsistentCasingInFileNames": true /* Ensure that casing is correct in imports. */,

    /* Type Checking */
    "strict": true /* Enable all strict type-checking options. */,
    "skipLibCheck": true /* Skip type checking all .d.ts files. */
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "exclude": ["node_modules"]
}
```

3. 新建`vite.config.ts`,配置跨域

```ts
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";

export default defineConfig({
  plugins: [vue()],
  base: "/",
  server: {
    port: 5755,
    proxy: {
      "/api": {
        changeOrigin: true,
        target: "http://localhost:3000",
        rewrite: (path) => path.replace(/^\/api/, ""),
      },
    },
  },
});
```

4. 项目根目录添加`index.html`

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

5. src 文件下添加`main.ts`入口文件、`style.css`样式文件和`vue.d.ts`

- main.ts

```ts
import { createApp } from "vue";
import App from "./APP.vue";
import "./style.css";
import ElementPlus from "element-plus";
import "element-plus/dist/index.css";

const app = createApp(App);
app.use(ElementPlus);
app.mount("#app");
```

- style.css

```css
html,
body,
#app {
  width: 100vw;
  height: 100vh;
  padding: 0;
  margin: 0;
  overflow: hidden;
}
```

- vue.d.ts

```ts
declare module "*.vue" {
  import type { DefineComponent } from "vue";
  const component: DefineComponent<{}, {}, any>;
  export default component;
}
```

6. src 目录下添加`APP.vue`文件，主要逻辑在里面

```vue
<script lang="ts" setup>
import { ref, reactive } from "vue";
import { User, Lock, View, Hide, Key } from "@element-plus/icons-vue";
import type { FormInstance, FormRules } from "element-plus";
import { ElMessage } from "element-plus";

const loginForm = reactive({
  username: "",
  password: "",
  code: "",
});

const loginFormRef = ref<FormInstance>();
const loading = ref(false);
const showPassword = ref(false);

const rules = reactive<FormRules>({
  username: [
    { required: true, message: "请输入用户名", trigger: "blur" },
    { min: 3, max: 20, message: "长度在 3 到 20 个字符", trigger: "blur" },
  ],
  password: [
    { required: true, message: "请输入密码", trigger: "blur" },
    { min: 6, max: 20, message: "长度在 6 到 20 个字符", trigger: "blur" },
  ],
  code: [
    { required: true, message: "请输入验证码", trigger: "blur" },
    { len: 4, message: "验证码长度为 4 位", trigger: "blur" },
  ],
});
// 验证码图的链接
const verificationCodeUrl = ref("");
const refreshVerificationCode = () => {
  // 这里添加刷新验证码的逻辑
  fetch("/api/VerificationCode")
    .then((res) => res.json())
    .then((res) => {
      verificationCodeUrl.value = res.image;
    });
};
// 进入页面获取一次验证码图
refreshVerificationCode();
// 登录
const handleLogin = async (formEl: FormInstance | undefined) => {
  if (!formEl) return;

  try {
    await formEl.validate();
    loading.value = true;

    // 这里添加实际的登录逻辑
    console.log("登录信息：", loginForm);

    fetch("/api/create", {
      method: "post",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        ...loginForm,
      }),
    })
      .then((res) => res.json())
      .then((res) => {
        console.log(res);

        ElMessage[res.code == 200 ? "success" : "error"](res.msg);
      });
  } catch (error) {
    console.error("登录失败：", error);
    ElMessage.error("登录失败，请检查输入");
  } finally {
    loading.value = false;
  }
};
</script>

<template>
  <div class="app-container">
    <div class="login-box">
      <h2 class="title">用户登录</h2>
      <el-form
        ref="loginFormRef"
        :model="loginForm"
        :rules="rules"
        label-width="0"
        size="large"
      >
        <el-form-item prop="username">
          <el-input
            v-model="loginForm.username"
            placeholder="请输入用户名"
            :prefix-icon="User"
          />
        </el-form-item>

        <el-form-item prop="password">
          <el-input
            v-model="loginForm.password"
            :type="showPassword ? 'text' : 'password'"
            placeholder="请输入密码"
            :prefix-icon="Lock"
            :suffix-icon="showPassword ? View : Hide"
            @click-suffix-icon="showPassword = !showPassword"
          />
        </el-form-item>

        <el-form-item prop="code">
          <div class="verification-code-container">
            <el-input
              v-model="loginForm.code"
              placeholder="请输入验证码"
              :prefix-icon="Key"
            />
            <img
              :src="verificationCodeUrl"
              class="verification-code-img"
              @click="refreshVerificationCode"
              alt="验证码"
            />
          </div>
        </el-form-item>

        <el-form-item>
          <el-button
            type="primary"
            :loading="loading"
            class="login-button"
            @click="handleLogin(loginFormRef)"
          >
            登录
          </el-button>
        </el-form-item>
      </el-form>
    </div>
  </div>
</template>

<style scoped>
.app-container {
  width: 100%;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #f5f5f5;
}

.login-box {
  width: 400px;
  padding: 40px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
}

.title {
  text-align: center;
  margin-bottom: 30px;
  color: #333;
}

.verification-code-container {
  display: flex;
  gap: 10px;
}

.verification-code-img {
  height: 40px;
  cursor: pointer;
}

.login-button {
  width: 100%;
}

:deep(.el-input__wrapper) {
  box-shadow: 0 0 0 1px #dcdfe6 inset;
}

:deep(.el-input__wrapper:hover) {
  box-shadow: 0 0 0 1px #409eff inset;
}
</style>
```
