## swagger 接口文档

`swagger` 用于提供给前端接口文档

## 所需依赖

```sh
npm install  @nestjs/swagger swagger-ui-express
```

## 注册启动

在`main.ts`中，首先使用`DocumentBuilder`创建文档配置，
然后使用`SwaggerModule.createDocument(app实例, 文档配置)`创建文档,
最后使用`SwaggerModule.setup('/访问地址', app实例, 创建的文档)`进行挂载

```ts
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import { SwaggerModule, DocumentBuilder } from "@nestjs/swagger";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // 接口文档设置
  const documentOptions = new DocumentBuilder()
    .setTitle("测试文档") // 文档标题
    .setDescription("文档描述") // 文档描述
    .setVersion("版本为1") // 文档版本
    .build();
  // 创建文档
  const documents = SwaggerModule.createDocument(app, documentOptions);
  // 注册swagger,并设置文档访问路径
  // 访问地址: http://localhost:3000/api-doc-ui
  SwaggerModule.setup("/api-doc-ui", app, documents);
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

## 分组

```ts
// user.controller.ts

import { Controller } from "@nestjs/common";
import { ApiTags } from "@nestjs/swagger";

@Controller("user")
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags("用户")
export class UserController {}
```

## 接口描述

```ts
// user.controller.ts

import { Controller, Get } from "@nestjs/common";
import { UserService } from "./user.service";
import { CreateUserDto } from "./dto/create-user.dto";
import { UpdateUserDto } from "./dto/update-user.dto";
import { ApiTags, ApiOperation } from "@nestjs/swagger";

@Controller("user")
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags("用户")
export class UserController {
  @Get()
  /**
   * 接口描述配置
   * @ApiOperation({ summary: '接口用处', description: '接口描述或解释' })
   */
  @ApiOperation({ summary: "获取所有用户", description: "使用GET方法哦" })
  findAll() {
    return this.userService.findAll();
  }
}
```

## 动态参数

```ts
// user.controller.ts

import { Controller, Get, Param } from "@nestjs/common";
import { UserService } from "./user.service";
import { CreateUserDto } from "./dto/create-user.dto";
import { UpdateUserDto } from "./dto/update-user.dto";
import { ApiParam } from "@nestjs/swagger";

@Controller("user")
export class UserController {
  @Get(":id")
  /**
   * 接口动态参数
   * @ApiParam({ name: '参数key',  description: '参数描述',required: [true | false] 是否为必须, })
   */
  @ApiParam({ name: "id", description: "用户id", required: true })
  @ApiOperation({ summary: "查询单一用户", description: "必须传用户id" })
  findOne(@Param("id") id: string) {
    return this.userService.findOne(+id);
  }
}
```

## query 参数

```ts
// user.controller.ts

import { Controller, Get } from '@nestjs/common';
import { UserService } from './user.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { ApiTags ApiQuery } from "@nestjs/swagger";

@Controller('user')
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags('用户')
export class UserController {

  @Get('/detail')
  /**
   * 接口query参数
   * @ApiQuery({name: 'key',description: 'key描述', required: 是否必须})
   */
  @ApiQuery({ name: 'email', description: '用户邮箱', required: true })
  @ApiQuery({ name: 'name', description: '用户名' })
  getDetail(@Query() query: any) {
    return query
  }
}

```

## post 请求

在`dto层`定义

```ts
// user.controller.ts

import { Controller, Post, Body } from "@nestjs/common";
import { UserService } from "./user.service";
import { CreateUserDto } from "./dto/create-user.dto";
import { ApiTags } from "@nestjs/swagger";

@Controller("user")
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags("用户")
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }
}
```

```ts
// create-user.dto

import { ApiProperty } from "@nestjs/swagger";

export class CreateUserDto {
  /**
   * post接口定义
   * @ApiProperty({ description: "描述", example: "例子值",required: 是否必须 })
   */
  @ApiProperty({ description: "姓名", example: "test", required: true })
  name: string;
}
```

## ApiResponse 自定义返回信息

```ts
// user.controller.ts

import { Controller, Param, Delete } from "@nestjs/common";
import { UserService } from "./user.service";
import { ApiTags, ApiResponse } from "@nestjs/swagger";

@Controller("user")
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags("用户")
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Delete(":id")
  /**
   * 返回Response例子
   * @ApiResponse({status:请求code,description:"自定义返回信息"})
   */
  @ApiResponse({ status: 403, description: "自定义返回信息" })
  remove(@Param("id") id: string) {
    return this.userService.remove(+id);
  }
}
```

## ApiBearerAuth jwt token

只需要在`main.ts`中创建文档配置时，添加`addBearerAuth()`,也就是`new DocumentBuilder().addBearerAuth()`,
然后在接口前或者`controller`前使用`@ApiBearerAuth()`装饰器即可

```ts
// main.ts

import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import { SwaggerModule, DocumentBuilder } from "@nestjs/swagger";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // 接口文档设置
  const documentOptions = new DocumentBuilder()
    .addBearerAuth() // 设置jwt token 验证
    .setTitle("测试文档") // 文档标题
    .setDescription("文档描述") // 文档描述
    .setVersion("版本为1") // 文档版本
    .build();
  // 创建文档
  const documents = SwaggerModule.createDocument(app, documentOptions);
  // 注册swagger,并设置文档访问路径
  // 访问地址: http://localhost:3000/api-doc-ui
  SwaggerModule.setup("/api-doc-ui", app, documents);
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

```ts
// user.controller.ts

import { Controller, Post, Body } from "@nestjs/common";
import { UserService } from "./user.service";
import { CreateUserDto } from "./dto/create-user.dto";
import { UpdateUserDto } from "./dto/update-user.dto";
import { ApiTags, ApiBearerAuth } from "@nestjs/swagger";

@Controller("user")
/**
 * 给接口文档分组
 * @ApiTags(分组名)
 */
@ApiTags("用户")
/**
 * 给该Controller的所有接口添加jwt token验证
 */
@ApiBearerAuth()
export class UserController {
  constructor(private readonly userService: UserService) {}

  @Post()
  /**
   * 给该接口的所有接口添加jwt token验证
   */
  @ApiBearerAuth()
  create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }
}
```

## swagger 文档其他装饰器

![swagger文档其他装饰器](/public/swagger文档其他装饰器.jpg)
