## 管道

管道是用 `@Injectable()` 装饰器注释的类，它实现了 `PipeTransform` 接口<br />
管道有两个典型的用例：

1. 转型：将输入数据转换为所需的形式（例如，从字符串到整数）,可以将前端传入的数据转成成我们需要的数据
2. 验证：评估输入数据，如果有效，只需将其原样传递；否则抛出异常, 类似于前端的 rules 配置验证规则

在这两种情况下，管道都在由 `控制器路由处理器` 处理的 `arguments` 上运行。
Nest 在调用方法之前插入一个管道，管道接收指定给该方法的参数并对它们进行操作。
任何转换或验证操作都会在此时发生，之后会使用任何（可能）转换的参数调用路由处理程序

### 八个内置转换 API

1. ValidationPipe
2. ParseIntPipe
3. ParseFloatPipe
4. ParseBoolPipe
5. ParseArrayPipe
6. ParseUUIDPipe
7. ParseEnumPipe
8. DefaultValuePipe

### 转换例子

本想接收的是一个`number`类型的参数，结果接收到的是`string`，可以利用转换去将该参数转换为`string`

```ts
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  ParseIntPipe,
} from "@nestjs/common";
import { PipeTestService } from "./pipe-test.service";
import { CreatePipeTestDto } from "./dto/create-pipe-test.dto";
import { UpdatePipeTestDto } from "./dto/update-pipe-test.dto";

@Controller("pipe-test")
export class PipeTestController {
  constructor(private readonly pipeTestService: PipeTestService) {}

  // 未转换前
  // @Get(':id')
  // findOne(@Param('id') id: string) {
  //   console.log(`当前id参数的类型是`, typeof id, id);
  //   return this.pipeTestService.findOne(+id);
  // }
  // 转换后
  @Get(":id")
  findOne(@Param("id", ParseIntPipe) id: string) {
    // 通过 ParseIntPipe 转换通道，把原本为 string类型的 id 转换为 number类型
    console.log(`当前id参数的类型是`, typeof id, id);
    return this.pipeTestService.findOne(+id);
  }
}
```

### 验证例子

验证 `uuid`的例子

1. 安装`uuid`依赖

```sh
npm i uuid -S
npm i @types/uuid -D
```

2. 验证`uuid`

```ts
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  ParseIntPipe,
  ParseUUIDPipe,
} from "@nestjs/common";
import { PipeTestService } from "./pipe-test.service";
import { CreatePipeTestDto } from "./dto/create-pipe-test.dto";
import { UpdatePipeTestDto } from "./dto/update-pipe-test.dto";

import * as uuid from "uuid";
// 生成一个uuid
console.log(uuid.v4());

@Controller("pipe-test")
export class PipeTestController {
  constructor(private readonly pipeTestService: PipeTestService) {}

  // 验证uuid
  /**
   * 未通过验证
   * 不走函数里面的代码，直接返回: 
   {
        "message": "Validation failed (uuid is expected)",
        "error": "Bad Request",
        "statusCode": 400
    } 
    
    * 通过验证：
      走函数中的代码，输出id和返回this.pipeTestService.update(+id, updatePipeTestDto)
   */
  @Patch(":id")
  update(
    @Param("id", ParseUUIDPipe) id: string,
    @Body() updatePipeTestDto: UpdatePipeTestDto
  ) {
    console.log(id, 1111111111111);
    return this.pipeTestService.update(+id, updatePipeTestDto);
  }
}
```
