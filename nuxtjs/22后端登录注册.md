## 后端

为了简化流程，很多东西没做，例如: `查询用户信息应该是查询数据库的`等...

### 启动 redis 和 mongoose 数据库

在这里，我使用的是`docker`启动服务

```sh
## 启动redis
docker run -d -p 6379:6379 --name redis redis

## 启动mongoose
docker run -d -p 27017:27017 --name mongodb -v mongo-data:/data/db   mongo
```

### 连接数据库, 并创建用户模型

在`~/server/modles/user.ts`

```ts
import { defineMongooseModel } from "#nuxt/mongoose";
import { User } from "~/utils/userSchema";

export const userSchema = defineMongooseModel<User>(
  "User",
  {
    username: String,
    code: String,
    email: {
      type: String,
      required: true,
    },
    password: {
      type: String,
      required: true,
    },
    phone: String,
    avatar: String,
    role: String,
    status: Number,
    createTime: Date,
    updateTime: Date,
    lastLoginTime: Date,
    disable: Boolean,
  },
  {
    timestamps: true, // 自动添加时间戳
  }
);
```

### 创建 redis 连接

利用`plugins`创建自定义`storage`连接`redis`,在`~/server/plugins/storage.ts`

```ts
import redisDriver from "unstorage/drivers/redis";

export default defineNitroPlugin((app) => {
  // 获取storage
  const storage = useStorage();
  // 获取 nuxt.config.ts中的环境变量
  const config = useRuntimeConfig();
  // 创建驱动
  const redis = redisDriver({
    // base: '', // 添加前缀，避免key冲突，不添加也可以
    host: config.redis.host,
    port: config.redis.port,
    db: 0,
  });
  console.log(config.redis);

  // 将redis挂载到storage上
  // 第一个参数是挂载的名称，第二个参数是驱动
  storage.mount("redis", redis);
  console.log("redis挂载成功");
});
```

### 授权验证中间件

在`~/server/middleware/auth.ts`

```ts
import jwt from "jsonwebtoken";
import whiteRoute from "~/utils/whiteRoute";
import { User } from "~/utils/userSchema";
export default defineEventHandler(async (event) => {
  const path = event.node.req.url;
  // 获取token
  const token = getCookie(event, "token");
  // 获取config
  const config = useRuntimeConfig();
  // 后端白名单
  const whiteList = whiteRoute.backend as string[];
  // 是否是前端路由
  if (!path?.startsWith("/api")) {
    return;
  }

  // 特定路由验证, 如果不是特定路由，直接返回
  if (whiteList.includes(path)) {
    return;
  }

  // 是否登录过
  if (!token) {
    throw createError({
      statusCode: 401,
      statusMessage: "未授权",
    });
  }

  try {
    // 解析token中信息
    const user = jwt.verify(token, config.tokenSecretOrPrivateKey) as User;
    // 将信息保存在接口的events中
    event.context.user = user;
  } catch (error) {
    // 删除cookie
    deleteCookie(event, "token");
    // 删除event.context.user
    delete event.context.user;

    throw createError({
      statusCode: 400,
      statusMessage: "token过期",
    });
  }
});
```

### 创建接口

统一在`~/server/api`目录下创建接口

#### user 接口模块

在`~/server/api/user`目录下

##### 注册接口(register.post.ts)

```ts
import { User } from "~/utils/userSchema";
import bcrypt from "bcrypt";
export default defineEventHandler(async (event) => {
  const { email, password, code } = await readBody<User>(event);
  const user = await userSchema.findOne({ email }).lean();
  // 查看数据库是否有该用户
  if (user) {
    throw createError({
      statusCode: 409,
      statusMessage: "用户已存在,请登录",
    });
  }
  // 验证码验证
  const registerCode = await useStorage("redis").getItem("registerCode");
  if (!code || registerCode != code) {
    throw createError({
      statusCode: 400,
      statusMessage: "验证码错误",
    });
  }
  // 密码加密
  // bcrypt.hash(加密内容, 加密强度)， 默认10
  const bcryptPassword = await bcrypt.hash(password, 10);
  // 将密码保存到数据库中
  const newUser = await userSchema.create({
    username: email,
    email,
    password: bcryptPassword,
    status: 0,
  });
  return {
    code: 200,
    message: "注册成功",
    data: newUser,
  };
});
```

##### 登录接口(login.post.ts)

```ts
import { User } from "~/utils/userSchema";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";

export default defineEventHandler(async (event) => {
  const { email, password } = await readBody<User>(event);
  // 获取环境变量
  const config = useRuntimeConfig();

  // 查询数据库
  const userData = await userSchema.findOne({ email }).exec();
  if (!userData) {
    throw createError({
      statusCode: 400,
      statusMessage: "用户不存在或者密码错误",
    });
  }
  // 对比密码
  const isPass = await bcrypt.compare(password, userData.password);
  if (!isPass) {
    throw createError({
      statusCode: 400,
      statusMessage: "用户不存在或者密码错误",
    });
  }

  // jwttoken生成， 比较敏感的信息可以放在环境.env文件中
  // payload: 载荷，也就是加密的数据
  // secretOrPrivateKey: 密钥
  // options: 选项
  // jwt.sign(payload, secretOrPrivateKey, [options, callback])
  const token = jwt.sign(userData.toJSON(), config.tokenSecretOrPrivateKey, {
    expiresIn: Number(config.tokenExpiresIn), // 过期时间, 默认是秒，1h：1小时
    algorithm: config.tokenAlgorithm as any, // 加密算法
  });

  // 保存到cookie
  setCookie(event, "token", token, {
    // httpOnly: true, // 只能在http请求中访问
    // secure: true, // 只能在https请求中访问
    // sameSite: 'strict', // 严格模式
    maxAge: Number(config.tokenExpiresIn), // 过期时间, 默认是秒，1h：1小时
  });

  // 修改数据库登录状态
  await userSchema.updateOne({ email }, { status: 1 });

  return {
    code: 200,
    message: "登录成功",
    data: {
      token,
      data: userData.toJSON({
        transform(doc, ret, options) {
          // 删除密码
          delete ret.password;
        },
      }),
    },
  };
  // const user = await prisma.user.findUnique({
  //   where: {
  //     email: body.email
  //   }
  // })
});
```

##### 退出登录接口(loginout.ts)

```ts
export default defineEventHandler(async (event) => {
  // 修改数据库登录状态
  const email = event.context.user?.email;
  await userSchema.updateOne({ email }, { status: 0 });
  // 删除cookie
  deleteCookie(event, "token", {
    path: "/",
  });
  // 删除上下文的信息
  delete event.context.user;

  return {
    code: 200,
    message: "退出成功",
  };
});
```

##### 获取个人信息接口(getUserData.ts)

正常来说，应该是通过传`用户id`来查询数据库

```ts
export default defineEventHandler(async (event) => {
  const userdata = event.context?.user || null;
  return {
    code: userdata ? 200 : 401,
    message: userdata ? "获取用户信息成功" : "用户未登录",
    data: userdata,
  };
});
```

##### 获取对应数据信息(findUserData.ts)

```ts
export default defineEventHandler(async (event) => {
  const query = await getQuery(event);
  const userData = await userSchema.findOne({ _id: query.id }).exec();
  return {
    code: userData ? 200 : 500,
    message: userData ? "获取用户信息成功" : "用户不存在",
    data: userData?.toJSON({
      transform(doc, ret, options) {
        // 删除密码
        delete ret.password;
      },
    }),
  };
});
```

#### 公用接口模块

在`~/server/api/utils`目录下

##### 注册验证码接口(registerCode.ts)

```ts
/**
 * 获取注册验证码
 */
export default defineEventHandler(async (event) => {
  const code = Math.random().toString().slice(-6);
  try {
    await useStorage("redis").setItem("registerCode", code, {
      // 设置过期时间
      ttl: 60 * 5,
    });
    return {
      code: 200,
      message: "验证码发送成功，5分钟内有效",
      data: {
        code,
      },
    };
  } catch (error) {
    throw createError({
      statusCode: 500,
      message: "验证码发送失败",
    });
  }
});
```
