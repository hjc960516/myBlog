## unStorage

`unStorage`中提供了很多内置工具，例如`redis`、`mysql`等等
[unStorage 文档](https://unstorage.unjs.io/drivers)

## redis

### 使用`docker`启动`redis`

如果需要启动本机的`redis`,请看关于 `blog中` 关于`redis`的文章

```sh
#启动redis
docker run -d --name redis -p 6379:6379 redis

# 查看redis是否启动
docker ps -a

#如果需要指定配置或者持久化数据，请看docker的文章
```

### 在`nuxt.config.ts`中添加`redis`配置

```ts
// https://nuxt.com/docs/api/configuration/nuxt-config
export default defineNuxtConfig({
  // 开启ssr，默认是开启的
  ssr: true,
  // 限定发布nuxt版本的时间
  compatibilityDate: "2024-11-01",
  // 是否开启调试工具
  devtools: { enabled: true },
  // 导入依赖
  modules: ["@vant/nuxt", "@pinia/nuxt"],
  // pinia: {
  //   // autoImports 配置允许你在 stores 文件夹中直接使用 defineStore 而无需显式导入。
  //   autoImports: ['defineStore', 'acceptHMRUpdate'], // 自动导入 defineStore 和 HMR 支持
  // },
  // 扫描目录，自动导入
  imports: {
    dirs: ["Astores"],
  },
  // 配置运行时的公共变量
  runtimeConfig: {
    public: {
      apiBase: process.env.NUXT_PUBLIC_API_BASE || "/api", // 代理基础路径
    },
  },
  // 配置跨域
  nitro: {
    logLevel: 1,
    devProxy: {
      "/apis": {
        target: "http://localhost:8090", // 后端 API 地址
        changeOrigin: true, // 修改 Origin 头为目标地址
        prependPath: true, // 保留 /api 后的路径
        rewrite: (path) => path.replace(/^\/apis/, ""), // 移除 /api 前缀
      },
    },
    // 添加redis
    storage: {
      redis: {
        driver: "redis", // 驱动类型
        host: "127.0.0.1", // 主机地址
        port: 6379, // 端口号
        password: "", // 密码
        db: 0, // 数据库
      },
    },
  },
  // 导入第三方或者自己写的样式，全局使用
  css: ["~/assets/local.css"],
  // 配置项目
  app: {
    head: {
      title: "my bilibili", // 页面标题
      charset: "utf-8", // 字符编码
      viewport: "width=device-width, initial-scale=1", // 视口设置
      meta: [
        // 元数据
        { name: "description", content: "my bilibili" },
      ],
      link: [
        // 链接
        { rel: "icon", type: "image/x-icon", href: "/favicon.ico" },
      ],
    },
  },
});
```

### 使用`useStorage`进行`redis`存储

#### 前端

在`/pages/redis/index.vue`

```vue
<template>
  <div>
    <div>存储redis,设置20秒过期</div>
    <button @click="saveRedis">存储redis</button>
    <button @click="getRedis">存储redis</button>
  </div>
</template>

<script setup lang="ts">
// 存储redis
const saveRedis = async () => {
  const res = await $fetch("/api/redis/saveRedis", {
    method: "POST",
    body: {
      name: "小新",
      age: 18,
      ttl: 10, // 设置过期时间
    },
  });
  console.log(res);
};
// 获取redis
const getRedis = async () => {
  const res = await $fetch("/api/redis/getRedis");
  console.log(res);
};
</script>

<style scoped></style>
```

#### 后端

1. 在`/api/redis/saveRedis.post.ts`

```ts
export default defineEventHandler(async (event) => {
  const body = await readBody(event);
  const { name, age, ttl } = body;
  // 保存到redis
  // ttl: 过期时间，单位为秒
  await useStorage("redis").setItem("redisInfo", { name, age }, { ttl });
  return {
    code: 200,
    message: "保存成功",
    data: {
      name,
      age,
      ttl,
    },
  };
});
```

2. 在`/api/redis/getRedis.ts`

```ts
export default defineEventHandler(async (event) => {
  // 查看是否存在redisInfo数据
  const redisInfo = await useStorage("redis").hasItem("redisInfo");
  if (!redisInfo) {
    return {
      code: 404,
      message: "未找到redisInfo数据",
      data: null,
    };
  }
  // 获取redis中保存的信息
  const redisInfoData = await useStorage("redis").getItem("redisInfo");
  return {
    code: 200,
    message: "获取成功",
    data: redisInfoData,
  };
});
```
