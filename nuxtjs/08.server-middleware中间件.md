## server 层中间件

在`nuxt`中创建`中间件`，是通过`/server/middleware`的目录下进行创建。<br />
在`nuxt`中的`server`层，所有的`中间件`都是`全局的`。如果需要`路由中间件`，需要自己做特殊处理

## 全局中间件

1. 在`/server/middleware`下创建`log.ts`
2. 编写`log.ts`

```ts
export default defineEventHandler(async (event) => {
  const url = getRequestURL(event);
  console.log(`当前的url是 ${url}`);
});
```

3. 测试请求任何接口，看是否打印日志

## 路由中间件

根据路由权限进行中间件处理,只有特定的`接口`才走中间件验证

1. 创建`server/routeMiddleware`, 该`routeMiddleware`文件不会纳入监控范围，需要自己手动在`目标接口进行导入验证`

2. 创建`server/routeMiddleware/permission.ts`

```ts
import { H3Event } from "h3";

export default async (event: H3Event) => {
  // 模拟验证信息
  const user = await Promise.resolve({
    id: 1,
    isLogin: false,
    username: "admin",
    password: "123456",
  });

  // 判断是否登录
  if (!user.isLogin) {
    throw createError({
      statusCode: 401,
      statusMessage: "未登录",
      message: "Unauthorized",
    });
  }
};
```

3. 在`server/api/user/[id].ts`中进行验证, 而在`api/test`中没有添加，所以不会走中间件验证

```ts
import presission from "~/server/middleware/pression";

export default defineEventHandler(async (event) => {
  // 验证权限
  await presission(event);

  // 获取param
  const id = getRouterParam(event, "id");

  return Promise.resolve({
    code: 200,
    message: "get请求成功",
    data: {
      id,
    },
  });
});
```

4. 通过请求`/api/test`和`api/user/1`进行测试
