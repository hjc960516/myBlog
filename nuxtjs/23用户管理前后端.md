## 用户管理实现

## 路由配置重定向

将`/`路由重定向到`/userManage`, 在`nuxt.config.ts`中添加`routeRules`, 之前的配置也别`漏了`

```ts
export default defineNuxtConfig({
  // 路由配置
  routeRules: {
    "/": {
      redirect: "/userManage",
    },
  },
});
```

## 前端

### 修改 slider 侧边栏组件

```vue
<script setup lang="ts">
import type { NavigationMenuItem } from "@nuxt/ui";

const items = ref<NavigationMenuItem[][]>([
  [
    {
      label: "用户管理",
      type: "link",
      to: "/userManage",
    },
  ],
]);
</script>

<template>
  <UNavigationMenu orientation="vertical" :items="items" class="w-full" />
</template>
```

### 添加公用组件

1. 在`~/components/Pagination.vue`

```vue
<template>
  <div class="flex items-center justify-end">
    <UBadge
      v-if="
        props.props.showCurrentPage === undefined
          ? true
          : props.props.showCurrentPage
      "
      :color="props.props.color"
      :size="props.props.size"
      >当前页:{{ props.props.page }}</UBadge
    >
    <div
      class="flex items-center mx-2"
      v-if="
        props.props.showSelectPage === undefined
          ? true
          : props.props.showSelectPage
      "
    >
      <span class="mr-1"> 每页数量: </span>
      <USelect
        v-model="selectValue"
        :color="props.props.color"
        :variant="
          props.props.variant != 'link' ? props.props.variant : 'outline'
        "
        :items="props.props.pageSizes || defaultPageSizes"
        class="w-[80px]"
        @update:modelValue="(value:any) => handleChange('pageSize',value)"
      />
      <span>条</span>
    </div>
    <UBadge
      class="mr-2"
      v-if="props.props.showTotal === undefined ? true : props.props.showTotal"
      :color="props.props.color"
      :size="props.props.size"
      >共:{{ props.props.page }}条</UBadge
    >
    <UPagination
      v-model:page="props.props.page"
      :active-color="props.props.activeColor"
      :total="props.props.total"
      :page-size="props.props.pageSize"
      :color="props.props.color"
      :variant="props.props.variant"
      :size="props.props.size"
      :activeVariant="props.props.activeVariant"
      :disabled="props.props.disabled"
      @update:page="(page:number) =>handleChange('page',page)"
    />
  </div>
</template>

<script setup lang="ts">
import type { PaginationProps, SelectItem } from "#ui/types";

interface Props {
  props: PaginationProps & {
    pageSize: number; // 每页数量
    pageSizes?: number[] | SelectItem[] | SelectItem[][]; // 每页数量选项
    showTotal?: boolean; // 是否显示总数量
    showCurrentPage?: boolean; // 是否显示当前页
    showSelectPage?: boolean; // 是否显示每页数量选择器
  };
}
const props = defineProps<Props>();
const defaultPageSizes = [10, 20, 30, 40, 50, 100];
const selectValue = computed({
  get() {
    return props.props.pageSize;
  },
  set(value: number) {
    props.props.pageSize = value;
  },
});

const emits = defineEmits(["update"]);
const handleChange = (type: "page" | "pageSize", value: number) => {
  emits(`update`, { type, value });
};
</script>

<style scoped></style>
```

2. 在`~/components/myForm.vue`

```vue
<template>
  <div>
    <UForm
      :schema="schema"
      :state="form"
      :class="className || 'w-full flex items-center justify-between flex-wrap'"
    >
      <template v-for="column in columns">
        <UFormField
          :label="column.label"
          :name="column.name"
          :required="column.required"
          :ui="
            column.ui || {
              label: 'w-[80px] text-right',
              container: 'flex-1',
              root: 'w-[49%]',
            }
          "
          class="flex items-center gap-4"
          :class="column.class"
        >
          <template v-if="column.type !== 'slot'">
            <component
              :is="componentMap[column.type]"
              :="column.props"
              class="w-full"
            >
              <slot :name="column.key + '-slot'"></slot>
            </component>
          </template>
          <template v-else>
            <slot :name="column.slotName"></slot>
          </template>
        </UFormField>
      </template>
    </UForm>
  </div>
</template>

<script setup lang="ts">
import type {
  FormFieldProps,
  InputProps,
  InputMenuProps,
  SelectProps,
  RadioGroupProps,
  CheckboxProps,
  SwitchProps,
} from "#ui/types";
import UInput from "#ui/components/Input.vue";
import USelect from "#ui/components/Select.vue";
import { cloneDeep } from "es-toolkit";
export interface Columns extends FormFieldProps {
  key: string; // 表单项的key
  type: "slot" | "UInput" | "UInputMenu" | "USelect" | "USelectMenu"; // 组件
  slotName?: string; // 自定义插槽名称
  props?: // 组件的props
  | InputProps
    | InputMenuProps
    | SelectProps
    | RadioGroupProps
    | CheckboxProps
    | SwitchProps
    | undefined;
}

const componentMap: any = {
  UInput,
  USelect,
};

interface Props {
  schema: any;
  state: any;
  className?: string | string[];
  columns: Columns[];
}

const props = defineProps<Props>();

const form = computed(() => {
  console.log(props.state);

  return cloneDeep(props.state);
});

/**
 * 获取表单数据
 */
function getFormData() {
  return form.value;
}

defineExpose({
  getFormData,
});
</script>

<style scoped></style>
```

### 用户管理页面

在`~/pages/userManage/index.vue`

```vue
<template>
  <div class="user-manage-container w-full h-full flex flex-col">
    <!-- 搜索 -->
    <div class="user-manage-header flex items-center">
      <UInput
        class="mr-3"
        icon="i-lucide-search"
        size="md"
        variant="outline"
        placeholder="请输入关键词..."
        v-model="searchData.keyWord"
      >
        <template v-if="searchData.keyWord?.length" #trailing>
          <UButton
            color="neutral"
            variant="link"
            size="sm"
            icon="i-lucide-circle-x"
            aria-label="Clear input"
            @click="searchData.keyWord = ''"
          />
        </template>
      </UInput>

      <UButton label="搜索" @click="refresh" />
    </div>
    <!-- table表 -->
    <div class="user-manage-content flex-1 w-full my-3">
      <UTable
        sticky
        :loading="pending"
        loading-color="primary"
        loading-animation="carousel"
        v-model:sorting="sorting"
        :data="userList"
        :columns="columns"
        class="border border-gray-300 h-full"
        :ui="{
          th: 'border-r border-gray-200 text-center',
          td: 'border border-gray-200 text-center',
        }"
        :sorting-options="sortingOptions"
      >
        <template #edit-cell="{ row }">
          <div class="flex items-center justify-center">
            <UButton
              type="link"
              label="编辑"
              color="secondary"
              variant="outline"
              @click="handleTable('edit', row.original)"
            />
            <!-- 弹窗 -->
            <Comfirm
              ref="comfirmRef"
              :title="`确定要删除${row.original.username}吗？`"
              :content="`删除后将无法恢复，请谨慎操作`"
              @confirm="handleTable('delete', row.original)"
            >
              <UButton
                class="ml-2"
                label="删除"
                color="error"
                variant="outline"
                :disabled="row.original.email == store?.email"
              />
            </Comfirm>
          </div>
        </template>
      </UTable>
    </div>
    <!-- 分页管理 -->
    <Pagination :props="searchData" @update="handleUpdatePagination" />
  </div>
</template>

<script setup lang="ts">
import { h, resolveComponent } from "vue";
import type { TableColumn } from "#ui/types";
import type { User } from "#imports";
import dayjs from "dayjs";
import { cloneDeep } from "es-toolkit";

// 组件
const UBadge = resolveComponent("UBadge");
const UButton = resolveComponent("UButton");
const comfirmRef = useTemplateRef("comfirmRef");
const USwitch = resolveComponent("USwitch");
// user的状态管理
const store = userStore().userData;
// 搜索表单
const searchData = reactive({
  keyWord: "",
  page: 1,
  pageSize: 10,
  total: 0,
});
/**
 * 排序字段
 */
const sorting = ref([]);
const body = computed(() => {
  return {
    ...searchData,
    sort: sorting.value,
  };
});
/**
 * 获取数据
 */
const { data, pending, error, refresh } = useFetch("/api/user/getUserList", {
  method: "post",
  body: body,
  // 监听数据变化，触发重新请求，不能使用reactive，因为监听的是整个依赖对象
  // watch: [],
  watch: false,
  // 返回数据的时候做的操作
  transform(data: any) {
    searchData.total = data.total;
    const list = data?.data || [];
    data.data = list?.map((item: any) => {
      item.createdAt = dayjs(item.createdAt).format("YYYY-MM-DD HH:mm:ss");
      item.updatedAt = dayjs(item.updatedAt).format("YYYY-MM-DD HH:mm:ss");
      return item;
    });
    return data;
  },
});
/**
 * 监听数据变化，重新发送请求
 */
watch(
  [() => searchData.pageSize, () => searchData.page, () => sorting.value],
  () => {
    refresh();
  }
);

/**
 * 数据
 */
const userList = computed(() => {
  const list: User[] = data.value?.data || [];
  return list;
});
/**
 * 排序配置
 */
const sortingOptions = {
  enableSorting: false, // 禁用排序,在后端进行排序
};
/**
 * 列配置
 */
const columns: TableColumn<User>[] = [
  {
    header: "序号",
    cell: ({ row }) => row.index + 1,
  },
  {
    accessorKey: "username",
    header: ({ column }) => {
      const isSorted = column.getIsSorted();
      // return `${row.getValue("username") || row.getValue("email")}`;
      return h(UButton, {
        color: "neutral",
        variant: "ghost",
        label: "用户名",
        icon: isSorted
          ? isSorted === "asc"
            ? "i-lucide-arrow-up-narrow-wide"
            : "i-lucide-arrow-down-wide-narrow"
          : "i-lucide-arrow-up-down",
        class: "-mx-2.5",
        onClick: () => {
          if (isSorted === false) {
            column.toggleSorting(false); // 无排序 -> 升序
          } else if (isSorted === "asc") {
            column.toggleSorting(true); // 升序 -> 降序
          } else {
            column.clearSorting(); // 降序 -> 无排序
          }
        },
      });
    },
    cell: ({ row }) => {
      const value = row.getValue("username") as string | undefined;
      return h(
        "div",
        { class: !value ? "text-red-500" : "" },
        value ? value : "未设置"
      );
    },
  },
  {
    accessorKey: "email",
    header: "邮箱",
  },
  {
    accessorKey: "status",
    header: "登录状态",
    cell: ({ row }) => {
      const color = {
        1: "success" as const,
        0: "error" as const,
        undefined: "warning" as const,
      }[row.getValue("status") as string];

      return h(UBadge, { class: "capitalize", variant: "subtle", color }, () =>
        row.getValue("status") == 1 ? "已登录" : "未登录"
      );
    },
  },
  {
    accessorKey: "role",
    header: "角色",
    cell: ({ row }) => {
      const value = row.getValue("role") as string | undefined;
      return h(
        "div",
        { class: !value ? "text-red-500" : "" },
        value ? value : "未设置"
      );
    },
  },
  {
    accessorKey: "phone",
    header: "手机号",
    cell: ({ row }) => {
      const value = row.getValue("phone") as string | undefined;
      return h(
        "div",
        { class: !value ? "text-red-500" : "" },
        value ? value : "未设置"
      );
    },
  },
  {
    accessorKey: "createdAt",
    header: ({ column }) => {
      const isSorted = column.getIsSorted();
      // return `${row.getValue("username") || row.getValue("email")}`;
      return h(UButton, {
        color: "neutral",
        variant: "ghost",
        label: "创建时间",
        icon: isSorted
          ? isSorted === "asc"
            ? "i-lucide-arrow-up-narrow-wide"
            : "i-lucide-arrow-down-wide-narrow"
          : "i-lucide-arrow-up-down",
        class: "-mx-2.5",
        onClick: () => {
          if (isSorted === false) {
            column.toggleSorting(false); // 无排序 -> 升序
          } else if (isSorted === "asc") {
            column.toggleSorting(true); // 升序 -> 降序
          } else {
            column.clearSorting(); // 降序 -> 无排序
          }
        },
      });
    },
  },
  {
    accessorKey: "updatedAt",
    header: "更新时间",
  },
  {
    header: "禁用",
    accessorKey: "disable",
    cell: ({ row }) => {
      const disable = row.getValue("disable") as boolean | undefined;
      return h(USwitch, {
        modelValue: disable,
        "onUpdate:modelValue": async (checked: boolean) => {
          const newdata = cloneDeep(row.original);
          newdata.disable = checked;
          const [error, res] = await fetchHandle("/api/user/updateUser", {
            method: "patch",
            body: newdata,
          });
          if (error) {
            toast.add({
              title: "更新失败",
              color: "error",
            });
          } else {
            comfirmRef.value?.handleVisible(false);
            toast.add({
              title: "更新成功",
              color: "success",
            });
            refresh();
          }
        },
      });
    },
  },
  {
    header: "编辑",
    id: "edit",
  },
];

/**
 * 分页更新
 */
const handleUpdatePagination = (props: {
  type: "page" | "pageSize";
  value: any;
}) => {
  searchData[props.type] = props.value;
};

const toast = useToast();

/**
 * table操作
 */
const handleTable = async (event: "edit" | "delete", data: any) => {
  if (event == "delete") {
    const [error, res] = await fetchHandle("/api/user/deleteUsers", {
      method: "POST",
      body: { ids: [data._id] },
    });
    if (error) {
      toast.add({
        title: "删除失败",
        color: "error",
      });
    } else {
      comfirmRef.value?.handleVisible(false);
      toast.add({
        title: "删除成功",
        color: "success",
      });
      refresh();
    }
  } else {
    navigateTo({
      path: `/userManage/${data._id}`,
    });
  }
};
</script>

<style scoped></style>
```

### 用户编辑页面

在`~/pages/userManage/[id].vue`

```vue
<template>
  <div class="w-full h-full flex items-center justify-center flex-col">
    <myForm ref="myFormRef" :schema="schema" :state="form" :columns="columns">
      <template #footer>
        <div class="w-full flex mt-[20px] items-center justify-center gap-2">
          <UButton
            color="neutral"
            variant="outline"
            @click="handleEvent('cancel')"
            >取消</UButton
          >
          <UButton @click="handleEvent('comfirm')">确定</UButton>
        </div>
      </template>
    </myForm>
  </div>
</template>

<script setup lang="ts">
import { useRoute } from "vue-router";
import { userSchema } from "#imports";
import type { Columns } from "~/components/myForm.vue";
import zod from "zod";
import { cloneDeep } from "es-toolkit";

definePageMeta({
  layout: "full-screen",
});
const route = useRoute();
// 排除密码和code字段
const schema = userSchema.omit({
  password: true,
  code: true,
  createdAt: true,
  updatedAt: true,
});
const myFormRef = useTemplateRef("myFormRef");
const form = ref<zod.infer<typeof schema> | null>(null);
const originalForm = ref<zod.infer<typeof schema> | null>(null);
const columns: Columns[] = [
  {
    label: "用户名",
    key: "username",
    type: "UInput",
    required: true,
  },
  {
    label: "头像",
    key: "avatar",
    type: "Upload",
    props: {
      type: "avatar",
      async handleUpload(file) {
        const formdata = new FormData();
        formdata.append("type", "avatar");
        formdata.append("id", route.params.id as string);
        formdata.append("file", file);
        const [error, res] = await fetchHandle("/api/utils/uploadFile", {
          method: "POST",
          body: formdata,
        });
        if (form.value) {
          form.value.avatar = res.data.url;
        }
      },
      handleClear() {
        form.value!.avatar = originalForm.value?.avatar;
      },
    },
  },
  // {
  //   label: "邮箱",
  //   key: "email",
  //   type: "UInput",
  //   required: true,
  //   props: {
  //     disabled: true,
  //   },
  // },
  {
    label: "角色",
    key: "role",
    type: "USelect",
    props: {
      items: [
        {
          label: "管理员",
          value: "admin",
        },
        {
          label: "普通用户",
          value: "user",
        },
      ],
    },
  },
  {
    label: "电话号码",
    key: "phone",
    type: "UInput",
  },
];

/**
 * 获取数据
 */
const getData = async () => {
  const [error, res] = await fetchHandle("/api/user/findUserData", {
    method: "get",
    query: {
      id: route.params.id,
    },
  });
  if (error) {
    const toast = useToast();
    toast.add({
      title: "获取失败",
      description: error.message,
      color: "error",
    });
    return;
  }
  form.value = res?.data || null;
  // 保存原本的数据，复现头像
  originalForm.value = cloneDeep(res?.data || null);
};
getData();

/**
 * 处理事件
 */
const handleEvent = async (event: "cancel" | "comfirm") => {
  if (event == "cancel") {
    navigateTo({
      replace: true,
      path: "/userManage",
    });
  } else {
    const isValid = await myFormRef.value?.validate();
    const toast = useToast();
    if (isValid === false) {
      toast.add({
        title: "提示",
        description: "请填写所有必填项",
        color: "error",
      });
      return;
    }
    const formData = myFormRef.value?.getFormData();
    const [error, res] = await fetchHandle("/api/user/updateUser", {
      method: "PATCH",
      body: formData,
    });
    toast.add({
      title: error ? "更新失败" : "更新成功",
      color: error ? "error" : "success",
    });
    if (!error) {
      navigateTo({
        replace: true,
        path: "/userManage",
      });
    }
  }
};
</script>

<style scoped></style>
```

## 后端

### 用户列表(~/server/api/user/getUserList.post.ts)

```ts
import type { SortOrder } from "mongoose";
/**
 * 获取用户列表
 */
export default defineEventHandler(async (event) => {
  const { page, pageSize, keyWord, sort } = await readBody(event);
  const sortObj: Record<string, SortOrder> = {};
  if (sort.length > 0) {
    sortObj[sort[0].id] = sort[0].desc ? "desc" : "asc";
  }
  const userList = await userSchema
    .find({
      $or: [
        {
          username: {
            $regex: keyWord,
          },
        },
        {
          email: {
            $regex: keyWord,
          },
        },
      ],
    })
    .skip((page - 1) * pageSize)
    .limit(pageSize)
    .sort(sortObj)
    .exec();

  const total = await userSchema.find({}).countDocuments();
  const totalPage = Math.ceil(total / pageSize);
  return {
    code: 200,
    msg: "获取用户列表成功",
    data: userList.map((user) =>
      user.toJSON({
        transform(doc, ret, options) {
          // 删除密码
          delete ret.password;
        },
      })
    ),
    total,
    totalPage,
    currentPage: page,
    pageSize,
  };
});
```

### 用户信息(~/server/api/user/getUserData.ts)

```ts
export default defineEventHandler(async (event) => {
  const userdata = event.context?.user || null;
  return {
    code: userdata ? 200 : 401,
    message: userdata ? "获取用户信息成功" : "用户未登录",
    data: userdata,
  };
});
```

### 删除用户(~/server/api/user/deleteUsers.post.ts)

```ts
/**
 * 删除用户
 */
export default defineEventHandler(async (event) => {
  const { ids } = await readBody(event);
  try {
    const users = await userSchema.find({ _id: { $in: ids } }).lean();
    await userSchema.deleteMany({ _id: { $in: ids } });
    return {
      code: 200,
      message: "删除成功",
      data: users,
    };
  } catch (error: any) {
    throw createError({
      statusCode: 500,
      statusMessage: "删除用户失败",
      data: error.message,
    });
  }
});
```

### 更新用户信息(~/server/api/user/updateUser.patch.ts)

```ts
export default defineEventHandler(async (event) => {
  const body = await readBody(event);
  const _id = body._id;
  const user = await userSchema.findByIdAndUpdate(_id, body, { new: true });
  return {
    code: 200,
    message: "更新成功",
    data: user,
  };
});
```

### 上传文件接口

在`~/server/api/utils/uploadFile.ts`, 分为`两种方法`,分别是`存在项目下`、`使用云服务端的oss`,
如果需要使用`随机唯一id`可以使用`nanoid`这个库,也可以使用其他的

#### `存在项目下`

直接存在项目下的`~/server/assets`中, 然后在`nuxt.config.ts`中修改配置，将`~/server/assets`文件目录改为`静态文件夹`

- `添加静态文件夹配置(nuxt.config.ts)`
  在`nitro`配置中添加`publicAssets`配置，将`~/server/assets`文件目录改为`静态文件夹`

```ts
import { resolve } from "path";
export default defineNuxtConfig({
  nitro: {
    // 设为静态文件服务
    publicAssets: [
      {
        baseURL: "/upload",
        dir: resolve("server/assets"), // 使用node的path.resolve方法确保路径正确
        maxAge: 60 * 60 * 24 * 7, // 7 days
      },
    ],
  },
});
```

#### `存在云端服务端的oss`

我这里使用的是`阿里的服务器`, 如何配置请看文章:[文章地址跳转](https://hjc960516.github.io/myBlog/node/oss.html)

- 所需依赖

```sh
  ## 连接阿里oss存储库依赖
  npm i ali-oss @types/ali-oss
```

- 配置`.env`文件

```env
# alioss配置
NUXT_ALIOSS_ACCESS_KEY_ID=你的AccessKeyId
NUXT_ALIOSS_ACCESS_KEY_SECRET=你的AccessKeySecret
NUXT_ALIOSS_BUCKET=你的阿里云oss新建的桶名
NUXT_ALIOSS_REGION=oss-cn-guangzhou # oss-cn-guangzhou这是我的服务器地
NUXT_ALIOSS_ENDPOINT=oss-cn-guangzhou.aliyuncs.com
```

- 配置`nuxt.config.ts`
  在`runtimeConfig`中添加

```ts
export default defineNuxtConfig({
  // 环境变量配置, 如果需要曝露给前端，则需要在public中
  runtimeConfig: {
    // 通过驼峰法来匹配, 例如: aNameConst, .env中配置就是NUXT_A_NAME_CONST
    // alioss配置
    alioss: {
      accessKeyId: "", // 访问密钥ID
      accessKeySecret: "", // 访问密钥
      bucket: "", // 存储空间
      region: "", // 区域
      endpoint: "", // 访问域名
    },
    // 前后端都可用
    public: {},
  },
});
```

- 在`nitroAPP`实例上扩展`aioss`
  在`~/types/nitro.d.ts`

```ts
import AliOss from "ali-oss";
// 给nitro的app添加alioss的ts类型
declare module "nitropack" {
  interface NitroApp {
    alioss: AliOss;
  }
}
```

- 使用`nitroPlugins`挂载链接`alioss`
  在`~/server/plugins/alioss.ts`,因为我们只需要挂载实例化一次`oss`, 如果放在接口中会多次实例化，耗费不必要的性能

```ts
import AliOss from "ali-oss";
export default defineNitroPlugin((nitro) => {
  // 获取阿里oss配置
  const { alioss } = useRuntimeConfig();
  // 创建阿里oss实例, 这里可以直接将alioss放进去，我只是为为了方便看懂才结构出来
  const client = new AliOss({
    region: alioss.region,
    accessKeyId: alioss.accessKeyId,
    accessKeySecret: alioss.accessKeySecret,
    bucket: alioss.bucket,
    endpoint: alioss.endpoint,
  });
  nitro.alioss = client;
});
```

#### 接口代码

```ts
import fs from "node:fs";
import path, { extname } from "node:path";

export default defineEventHandler(async (event) => {
  const headers = await getRequestHeaders(event);
  // 直接获取formdata的二进制数据
  // const formdata = await readRawBody(event,false)

  // 方法一：直接写入到项目中的~/server/assets中
  // 获取扩展名
  // // 获取整个formdata
  // const formdata = await readMultipartFormData(event)
  // // 获取对应的文件
  // const file = formdata?.find(file => file.name === 'file')
  // // 获取对应的文件类型命名
  // const type = formdata?.find(file => file.name === 'type')?.data?.toString('utf8')
  // // 获取用户id
  // const userId = formdata?.find(file => file.name === 'id')?.data?.toString('utf8')
  // const ext = extname(file?.filename || '') || '.png'
  // const ext = '.png'
  // const originName = file?.filename || '' // 获取文件名(包含扩展名)
  // const assetsPath = path.join(process.cwd(), 'server', 'assets') // assets路径
  // const fileName = `${userId}-${type}${originName}`// 完整文件名
  // const filePath = path.join(assetsPath, fileName)// 文件路径
  // 获取所有文件
  // const allFiles = fs.readdirSync(assetsPath)
  // // 检查是否含有所在文件
  // const isExit = allFiles.find(file => file === fileName)

  // // 如果存在直接返回
  // if (isExit) {
  //   return {
  //     code: 200,
  //     message: '上传成功',
  //     data: {
  //       url: headers.origin + '/upload/' + fileName
  //     }
  //   }
  // }
  // const stream = fs.createWriteStream(filePath)
  // stream.write(file?.data)
  // stream.end()'
  // return new Promise((resolve, reject) => {
  //   stream.on('finish', () => {
  //     resolve({
  //       code: 200,
  //       message: '上传成功',
  //       data: {
  //         url: headers.origin + '/upload/' + fileName
  //       }
  //     })
  //   })
  //   stream.on('error', () => {
  //     reject({
  //       code: 500,
  //       message: '上传失败',
  //     })
  //   })
  // })

  // 方法二：利用 阿里云或者其他服务器的 oss 图库上传
  // 使用另外一种方法(readMultipartFormData)获取formdata, 获取到的是数组
  const formdata = await readMultipartFormData(event);
  // 获取对应的文件类型命名
  const type = formdata
    ?.find((item) => item.name == "type")
    ?.data?.toString("utf8");
  // 获取用户id
  const userId = formdata
    ?.find((item) => item.name == "id")
    ?.data?.toString("utf8");
  // 获取对应的文件
  const file = formdata?.find((item) => item.name == "file");
  // 文件名称 file?.filename是带后缀名的，如果需要后缀名(.xxx)，使用node:path中的extname获取
  const fileName = `${userId}-${type}${file?.filename}`;
  // 获取全局natro的app
  const natroapp = useNitroApp();
  try {
    // 上传图片到oss
    const result = await natroapp.alioss.put(fileName, file?.data);
    return {
      code: 200,
      message: "上传成功",
      data: {
        url: result?.url,
      },
    };
  } catch (error) {
    return {
      code: 500,
      message: "上传失败",
    };
  }
});
```
