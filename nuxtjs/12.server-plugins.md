## plugins

[plugins 文档](https://nitro.build/guide/plugins)<br />
在`/server/plugins`文件中，`nuxt`自动导入`plugins`文件，使用`defineNitroPlugin`定义插件, 其中有`生命周期`、`钩子`、`中间件`、`路由`等

## 生命周期

- `close`: 关闭
- `request`: 请求
- `beforeResponse`: 响应前
- `afterResponse`: 响应后
- `...`: 其他

```ts
export default defineNitroPlugin((app) => {
  // 请求
  app.hooks.hook("request", (event) => {
    // console.log(event);
    console.log("请求");
  });

  // 响应
  app.hooks.hook("afterResponse", (event, res) => {
    // console.log(event);
    console.log(res?.body);
    console.log("响应");
  });
});
```

## plugins 使用

利用`环境变量.env`文件，进行注册`redis`

### 在`nuxt.config.ts`设置`redis`

设置`runtimeConfig`，设置`redis`

```ts
// https://nuxt.com/docs/api/configuration/nuxt-config
export default defineNuxtConfig({
  // 开启ssr，默认是开启的
  ssr: true,
  // 限定发布nuxt版本的时间
  compatibilityDate: "2024-11-01",
  // 是否开启调试工具
  devtools: { enabled: true },
  // 配置运行时的公共变量
  runtimeConfig: {
    // 如果在.env中有定义会覆盖
    baseUrl: "333",
    // 没有定义可以引用
    testUrl: process.env.TEST_API,
    public: {
      apiBase: process.env.NUXT_PUBLIC_API_BASE || "/api", // 代理基础路径
    },
    // 使用plugins挂载redis
    redis: {
      host: "",
      port: 0,
    },
  },
});
```

### `.env`文件配置`redis`

```md
TEST_API=123
NUXT_BASE_URL=/ssss
NUXT_REDIS_HOST=127.0.0.1 # redis 地址
NUXT_REDIS_PORT=6379 # redis 端口
```

### 创建`plugin`

在`/server/plugins`中创建`storage.ts`

```ts
import redisDriver from "unstorage/drivers/redis";

export default defineNitroPlugin((app) => {
  // 获取storage
  const storage = useStorage();
  // 获取 nuxt.config.ts中的环境变量
  const config = useRuntimeConfig();
  // 创建驱动
  const redis = redisDriver({
    // base: '', // 添加前缀，避免key冲突，不添加也可以
    host: config.redis.host,
    port: config.redis.port,
    db: 0,
  });
  console.log(config.redis);

  // 将redis挂载到storage上
  // 第一个参数是挂载的名称，第二个参数是驱动
  storage.mount("redis", redis);
  console.log("redis挂载成功");
});
```

### 使用之前`redis`的接口测试
