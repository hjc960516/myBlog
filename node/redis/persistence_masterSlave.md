---
outline: deep

prev:
  text: "发布订阅和事务"
  link: "/node/redis/publish_subscribeAndTransaction"
next:
  text: "ioredis"
  link: "/node/redis/ioredis"
---

## 持久化

### RDB（Redis Database）持久化

RDB 是一种快照的形式，它会将内存中的数据定期保存到磁盘上。
可以通过配置 Redis 服务器，设置自动触发 RDB 快照的条件，比如在指定的时间间隔内，或者在指定的写操作次数达到一定阈值时进行快照保存。
RDB 持久化生成的快照文件是一个二进制文件，包含了 Redis 数据的完整状态。在恢复数据时，可以通过加载快照文件将数据重新加载到内存中

#### RDB 实现

- `windows`: 打开安装包的`redis.conf`配置文件
- `mac`: 如果是`brew`安装的, 配置文件路径是`/usr/local/etc/redis.conf`

:::warning 注意
在`mac`进行快照的时候，`dump.rdb`快照文件不在`/usr/local/Cellar/redis`这个下载文件路径里面 ,而是在`/usr/local/var/db/redis`
:::

```conf
# 在配置文件中加入, 也就是在设置的时间内，达到目标次数，会进行一次快照存进dump.rdb文件
# 弊端是: 如果设置了一个小时存一次，但是在一个半小时的时候服务器宕机了，那么会丢失半个小时的数据
# rdb持久化一般用来做数据备份
# save 时间(秒) 次数
save 3600 10 # 一个小时变化10次会进行一次快照
```

- `也可以手动进行快照`

```sh
# 在redis启动服务的命令行中手动进行rdb快照
save
```

### AOF（Append-Only File）持久化

AOF 持久化记录了 Redis 服务器执行的所有写操作命令，在文件中以追加的方式保存。
当 Redis 需要重启时，可以重新执行 AOF 文件中保存的命令，以重新构建数据集。相比于 RDB 持久化，AOF 持久化提供了更好的数据恢复保证，因为它记录了每个写操作，而不是快照的形式。
然而，AOF 文件相对于 RDB 文件更大，恢复数据的速度可能会比较慢

#### AOF 实现

在`redis.conf`配置文件中，把`appendonly`配置项改为`true`即可

## 主从复制

Redis 主从复制是一种数据复制和同步机制，其中一个 Redis 服务器（称为主服务器）将其数据复制到一个或多个其他 Redis 服务器（称为从服务器）。主从复制提供了数据冗余备份、读写分离和故障恢复等功能

## 工作流程

1. `配置主服务器`：在`主服务器`上，你需要在`配置文件`中启用`主从复制`并`指定从服务器的IP地址和端口号`。你可以使用`replicaof`配置选项或`slaveof`配置选项来指定从服务器
2. `连接从服务器`：从服务器连接到主服务器并发送复制请求。从服务器通过发送`SYNC`命令请求进行全量复制或通过发送`PSYNC`命令请求进行部分复制（增量复制）
3. `全量复制（SYNC）`：如果从服务器是第一次连接或无法执行部分复制，主服务器将执行全量复制。
   在全量复制期间，主服务器将快`照文件（RDB文件）`发送给从服务器，从服务器将接收并加载该文件以完全复制主服务器的数据
4. `部分复制（PSYNC）`：如果从服务器已经执行过全量复制并建立了复制断点，主服务器将执行部分复制。
   在部分复制期间，主服务器将发送增量复制流（replication stream）给从服务器，从服务器将接收并应用该流以保持与主服务器的同步
5. `复制持久化`：从服务器接收到数据后，会将其保存在`本地磁盘`上，以便在重启后仍然保持数据的一致性
6. `同步延迟`：从服务器的复制是`异步`的，因此存在复制延迟。延迟取决于`网络延迟`、`主服务器的负载`和`从服务器的性能`等因素
7. `读写分离`：一旦建立了主从复制关系，从服务器可以接收读操作。这使得可以将读流量从主服务器分散到从服务器上，从而减轻主服务器的负载
8. `故障恢复`：如果主服务器发生故障，可以将一个从服务器提升为新的主服务器，以继续提供服务。当主服务器恢复时，它可以作为从服务器连接到新的主服务器，继续进行数据复制

### 开启主服务器

```sh
# 默认端口是6379
redis-server

# 进入redis
redis-cli
```

### 新建从服务器配置文件

```conf
# redis-6380.conf

#ip地址 如果是mac电脑在 地址后面添加 `::1`
bind 127.0.0.1
#端口号
port 6380
#守护线程静默运行
daemonize yes
#指定主服务器
replicaof 127.0.0.1 6379
```

### 启动从服务器

```sh
redis-server 配置文件路径

# 开启端口为6380的redis
redis-cli -p 6380
```

### 测试

主服务器输入数据

```sh
set age 1
```

从服务器

```sh
# 得到的数据是 1
get age
```
