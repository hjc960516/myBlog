---
outline: deep

prev:
  text: "ioredis、express、lua脚本实现限流阀"
  link: "/node/ioredis_express_lua"
next:
  text: "serverLess(无服务架构)"
  link: "/node/serverless"
---

## 定时任务

定时任务是指在预定的时间点或时间间隔内执行的任务或操作。它们是自动化执行特定逻辑的一种方式，可用于执行重复性的、周期性的或计划性的任务

### 用处

1. `执行后台任务`：定时任务可用于自动执行后台任务，如数据备份、日志清理、缓存刷新等。通过设定适当的时间点或时间间隔，可以确保这些任务按计划进行，而无需手动干预
2. `执行定期操作`：定时任务可用于执行定期操作，如发送电子邮件提醒、生成报告、更新数据等。通过设定适当的时间点，可以自动触发这些操作，提高效率并减少人工操作的需求
3. `调度任务和工作流`：定时任务可以用于调度和协调复杂的任务和工作流程。通过设置任务之间的依赖关系和执

## node-schedule 定时任务库

一般定时任务都是用 `cron表达式`去表示时间的, 详情可见[文档](https://www.npmjs.com/package/node-schedule)

### cron 表达式

一种用于指定定时任务执行时间的字符串表示形式。它由 6 个或 7 个字段组成，每个字段表示任务执行的时间单位和范围

### 用法

```js
import nodeSchedule from "node-schedule";

// 每隔1秒执行一次
// scheduleJob(6-7个, () => {})
// 6-7个: 顺序是：秒 分 时 日 月 星期 年
// */10:每隔10秒执行一次 *:匹配所有的分钟 *:时 *：日 *：月 *：星期 *：年
// 例如 每天凌晨： 0 0 0 * * *
nodeSchedule.scheduleJob("*/10 * * * * *", () => {
  console.log("每隔1秒执行一次");
});
```

### 参数解释

|    参数顺序     | 是否必需 |      取值范围      |    特殊字符     |
| :-------------: | :------: | :----------------: | :-------------: |
|   秒 Seconds    |    是    |        0~59        |    `* , - /`    |
|  分钟 Minutes   |    是    |        0~59        |    `* , - /`    |
|   小时 Hours    |    是    |        0~23        |    `* , - /`    |
| 日期 DayofMonth |    是    |        1~31        | `* , - / ? L W` |
|   月份 Month    |    是    | 1~12 或者英文(JAN) |    `* , - /`    |
| 星期 DayofWeek  |    是    | 1~7 或者英文(MON)  | `* , - / ? L #` |
|     年 Year     |    是    |       1970+        |     `* - /`     |

每个字段可以接受特定的数值、范围、通配符和特殊字符来指定任务的执行时间:

- `数值`：表示具体的时间单位，如 1、2、10 等
- `范围(-)`：使用`-`连接起始和结束的数值，表示一个范围内的所有值，如 `1-5` 表示 `1 到 5` 的所有数值
- `通配符(*)`：使用`*`表示匹配该字段的所有可能值，如`*`表示`每分钟、每小时、每天`等
- `逗号分隔(,)`：使用`,`分隔多个数值或范围，表示匹配其中任意一个值，如 `1,3` 表示 `1 或 3`
- `步长(/)`：使用`/`表示`步长`，用于指定间隔的数值，如`*/5` 表示`每隔 5 个单位执行一次`
- `特殊字符`：Cron 表达式还支持一些特殊字符来表示特定的含义，如`?`用于`替代日和星期字段中的任意值`，`L`表示`最后一天`，`W`表示`最近的工作日`等

### 日常 corn 表达式

- `* * * * * *`: 每秒执行一次
- `0 * * * * *`: 每分钟整执行一次
- `0 0 * * * *`: 每小时整执行一次
- `0 0 * * 1 *`: 每周一的午夜执行一次任务
- `0 0 1 * * *`: 每月的 1 号午夜执行一次任务
- `0 0 1 1 * *`: 每年的 1 月 1 日午夜执行一次任务

## 自动请求项目

### 依赖

```sh
# request: 请求库
# node-schedule: node的定时任务库
npm i express request node-schedule
```

### index.js

```js
import nodeSchedule from "node-schedule";
import request from "request";

// 每隔1秒执行一次
// scheduleJob(6-7个, () => {})
// 6-7个: 顺序是：秒 分 时 日 月 星期 年
// */10:每隔10秒执行一次 *:匹配所有的分钟 *:时 *：日 *：月 *：星期 *：年
// 例如 每天凌晨： 0 0 0 * * *
// nodeSchedule.scheduleJob("*/10 * * * * *", () => {
//   console.log("每隔1秒执行一次");
// });

// 定时任务
// 每天凌晨00:30请求一次接口
nodeSchedule.scheduleJob("0 30 0 * * *", () => {
  request(
    "http://localhost:3000/test",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    },
    (err, res, body) => {
      console.log("每隔1秒执行一次");
      console.log(body);
    }
  );
});
```

### server.js

```js
// 该文件只用作测试定时任务请求
import express from "express";

const app = express();
app.use(express.json());

app.post("/test", (req, res) => {
  res.send({
    code: 200,
    message: "测试成功",
  });
});

app.listen(3000, () => {
  console.log("服务器启动成功: http://localhost:3000");
});
```
